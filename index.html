<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Supertrend Flips</title>
  <style>
    body {
      margin: 0;
      font-family: 'Courier New', monospace;
      background-color: black;
      color: white;
    }

    h1 {
      text-align: center;
      color: #00ff00;
      font-size: 2rem;
      margin-top: 1rem;
    }

    .search-bar {
      text-align: center;
      margin: 1rem 0 -0.5rem;
    }

    .search-bar input {
      background-color: #111;
      color: #00ff00;
      border: 1px solid #00ff00;
      padding: 0.5rem;
      border-radius: 4px;
      font-family: monospace;
      width: 250px;
      max-width: 90%;
    }

    .filters, .sub-filters {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.5rem;
      margin: 1rem 0;
    }

    .filters button, .sub-filters button {
      background-color: #111;
      color: #00ff00;
      border: 1px solid #00ff00;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }

    .filters button.active, .sub-filters button.active {
      background-color: #00ff00;
      color: black;
    }

    .sub-filters {
      margin-top: -0.5rem;
      margin-bottom: 1rem;
    }

    .sub-filters button {
      background-color: #222;
      color: #ccc;
      border: 1px solid #444;
      padding: 0.3rem 0.7rem;
      font-size: 0.85rem;
    }

    .symbol-section {
      max-width: 700px;
      margin: 0 auto 2rem;
      padding: 0 1rem;
    }

    .flip {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background-color: #111;
      padding: 1rem;
      margin: 0.4rem 0;
      border-radius: 8px;
      box-shadow: 0 0 10px #00ff0040;
      position: relative;
      flex-direction: column;
    }

    .flip-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
    }

    .flip-left {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 0.4rem;
    }

    .emoji {
      font-size: 1.4rem;
    }

    .logo {
      width: 20px;
      height: 20px;
      border-radius: 3px;
      margin-right: 5px;
    }

    .symbol-name {
      display: flex;
      flex-direction: column;
    }

    .symbol {
      color: white;
      font-weight: bold;
      font-size: 1.1rem;
    }

    .company {
      font-size: 0.85rem;
      color: #ccc;
    }

    .flipped {
      font-size: 1rem;
      color: #999;
    }

    .green {
      color: #00ff00;
      font-weight: bold;
    }

    .red {
      color: #ff0000;
      font-weight: bold;
    }

    .history-toggle {
      font-size: 1rem;
      cursor: pointer;
      color: #888;
    }

    .history-toggle:hover {
      text-decoration: underline;
    }

    .history-container {
      display: none;
      margin-top: 0.8rem;
      width: 100%;
    }

    .history-entry {
      display: flex;
      justify-content: space-between;
      padding: 0.4rem 1rem;
      background-color: #1a1a1a;
      margin-top: 0.3rem;
      border-radius: 6px;
    }

    @media (max-width: 600px) {
      .flip {
        gap: 0.5rem;
      }
    }
  </style>
</head>
<body>
  <h1>üìà Supertrend Flip Tracker</h1>

  <div class="search-bar">
    <input type="text" id="searchInput" placeholder="Search ticker..." />
  </div>

  <div class="filters">
    <button data-filter="all" class="active">All</button>
    <button data-filter="green">Bullish üêÇ</button>
    <button data-filter="red">Bearish üêª</button>
    <button data-filter="recent">Most Recent</button>
  </div>

  <div class="sub-filters" id="subFilters" style="display:none">
    <button data-sort="alpha" class="active">A‚ÄìZ</button>
    <button data-sort="recent">Most Recent</button>
  </div>

  <div id="flipContainer" class="symbol-section"></div>

  <script>
    Promise.all([
      fetch("public_flips.json").then(res => res.json()),
      fetch("company_info.json").then(res => res.json()).catch(() => ({}))
    ]).then(([data, companyData]) => {
      const container = document.getElementById("flipContainer");
      const subFilters = document.getElementById("subFilters");
      const state = {
        activeFilter: "all",
        sortBy: "alpha",
        searchQuery: ""
      };

      function renderFlips() {
        container.innerHTML = "";

        let entries = Object.entries(data).filter(([symbol, flips]) => {
          if (!Array.isArray(flips) || flips.length === 0) return false;
          if (!symbol.toLowerCase().includes(state.searchQuery.toLowerCase())) return false;

          if (state.activeFilter === "green" || state.activeFilter === "red") {
            return flips[0].type === state.activeFilter;
          }

          return true;
        });

        if (state.activeFilter === "recent") {
          entries.sort((a, b) => new Date(b[1][0].date) - new Date(a[1][0].date));
        } else if ((state.activeFilter === "green" || state.activeFilter === "red") && state.sortBy === "recent") {
          entries.sort((a, b) => new Date(b[1][0].date) - new Date(a[1][0].date));
        } else {
          entries.sort((a, b) => a[0].localeCompare(b[0]));
        }

        entries.forEach(([symbol, flips]) => {
          const latest = flips[0];
          const company = companyData[symbol]?.name || "";
          const logo = companyData[symbol]?.logo || "";
          const emoji = latest.type === "green" ? "üêÇ" : "üêª";
          const colorClass = latest.type === "green" ? "green" : "red";

          const box = document.createElement("div");
          box.className = `flip ${latest.type}`;

          box.innerHTML = `
            <div class="flip-header">
              <div class="flip-left">
                <span class="emoji">${emoji}</span>
                ${logo ? `<img src="${logo}" alt="${symbol} logo" class="logo" onerror="this.style.display='none';this.insertAdjacentHTML('afterend','üí≤')"/>` : '<span class="emoji">üí≤</span>'}
                <div class="symbol-name">
                  <span class="symbol">${symbol}</span>
                  ${company ? `<span class="company">${company}</span>` : ""}
                </div>
                <span class="flipped">flipped</span>
                <span class="${colorClass}">${latest.type.toUpperCase()}</span>
                ${state.activeFilter === "all" ? '<span class="history-toggle" title="View history">üìÇ</span>' : ""}
              </div>
              <div class="date ${colorClass}">${latest.date}</div>
            </div>
            <div class="history-container"></div>
          `;

          if (state.activeFilter === "all") {
            const toggle = box.querySelector(".history-toggle");
            const historyBox = box.querySelector(".history-container");

            toggle?.addEventListener("click", () => {
              if (historyBox.style.display === "block") {
                historyBox.style.display = "none";
              } else {
                historyBox.innerHTML = flips.map(f => `
                  <div class="history-entry">
                    <span class="${f.type === 'green' ? 'green' : 'red'}">${f.date}</span>
                    <span class="${f.type === 'green' ? 'green' : 'red'}">${f.type.toUpperCase()}</span>
                  </div>
                `).join("");
                historyBox.style.display = "block";
              }
            });
          }

          container.appendChild(box);
        });
      }

      document.querySelectorAll(".filters button").forEach(btn => {
        btn.addEventListener("click", () => {
          document.querySelectorAll(".filters button").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          state.activeFilter = btn.getAttribute("data-filter");
          subFilters.style.display = (state.activeFilter === "green" || state.activeFilter === "red") ? "flex" : "none";
          renderFlips();
        });
      });

      document.querySelectorAll(".sub-filters button").forEach(btn => {
        btn.addEventListener("click", () => {
          document.querySelectorAll(".sub-filters button").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          state.sortBy = btn.getAttribute("data-sort");
          renderFlips();
        });
      });

      document.getElementById("searchInput").addEventListener("input", (e) => {
        state.searchQuery = e.target.value;
        renderFlips();
      });

      renderFlips();
    });
  </script>
</body>
</html>
