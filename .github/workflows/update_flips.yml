name: Update Supertrend Flips

on:
  schedule:
    - cron: '0 0 * * *'   # 12:00 AM UTC
    - cron: '0 6 * * *'   # 6:00 AM UTC
    - cron: '0 12 * * *'  # 12:00 PM UTC
    - cron: '0 18 * * *'  # 6:00 PM UTC
  workflow_dispatch:

jobs:
  update-stocks:
    name: 🟢 Update Stock Flips
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: 🐍 Set Up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: 📦 Install Dependencies
        run: pip install -r requirements.txt

      - name: 📊 Run Stock Flip Update
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
        run: python update_flips.py --stocks

      - name: ✅ Commit and Push Stock Flips
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          git config --global user.email "nfgems@users.noreply.github.com"
          git config --global user.name "nfgems"
          git add public_flips_*.json
          git commit -m "🧠 Update STOCK flips [auto]" || echo "No changes to commit"
          git push origin HEAD

  update-crypto:
    name: 🟣 Update Crypto Flips
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: 🐍 Set Up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: 📦 Install Dependencies
        run: pip install -r requirements.txt

      - name: 🪙 Run Crypto Flip Update
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
        run: python update_flips.py --crypto

      - name: ✅ Commit and Push Crypto Flips
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          git config --global user.email "nfgems@users.noreply.github.com"
          git config --global user.name "nfgems"
          git add public_flips_crypto_*.json
          git commit -m "🧠 Update CRYPTO flips [auto]" || echo "No changes to commit"
          git push origin HEAD
